name: Deploy Laravel App

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e

            APP_PATH="/var/www/yash"

            echo "ğŸš€ Deploying Laravel App"
            cd $APP_PATH

            echo "ğŸ” Step 1: Temporarily give ownership to ubuntu (for git)"
            sudo chown -R ubuntu:ubuntu $APP_PATH

            echo "ğŸ“¥ Step 2: Pull latest code"
            git pull origin main

            echo "ğŸ” Step 3: Restore Laravel production ownership"
            sudo chown -R www-data:www-data $APP_PATH
            sudo chown -R ubuntu:ubuntu $APP_PATH/.git
            sudo chmod -R 775 $APP_PATH/storage $APP_PATH/bootstrap/cache

            echo "ğŸ“¦ Step 4: Install PHP dependencies"
            sudo -u www-data composer install --no-dev --optimize-autoloader

            echo "ğŸ§¹ Step 5: Optimize Laravel"
            sudo -u www-data php artisan optimize:clear
            sudo -u www-data php artisan config:cache
            #sudo -u www-data php artisan route:cache
            sudo -u www-data php artisan view:cache

            echo "ğŸ” Step 6: Restart services"
            sudo systemctl restart php8.2-fpm
            sudo systemctl reload nginx

            echo "âœ… Deployment complete"
